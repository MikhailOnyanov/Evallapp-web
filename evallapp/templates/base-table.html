{% extends 'base.html'%}

{% block content %}
<head>
    <title>Editable Table</title>
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/style.css') }}">

</head>
<body>
<div>
    <p>Выберите таблицу: </p>
    <p>
    <div class="select-dropdown">
        <select id="database-name-option">
            <option selected value="{{ list[0] }}">{{list[0]}}</option>
            {% for value in list[1:] %}
            <option value="{{ value }}">{{value}}</option>
            {% endfor %}
        </select>
    </div>
    </p>

    <hr>

    <div class="my_table" id="table"></div>

    <div class="important-buttons">
        <a href="#" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload"
                 viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
            </svg>
            Импорт Excel файла
        </a>
        <a href="#" class="btn btn-success" id="export-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download"
                 viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
            Экспорт таблицы в Excel
        </a>
    </div>

    <div class="system-messages">
        <ul id="sys-msgs">

        </ul>
    </div>

    <h3>Графики для таблицы "mistake_type_sum_by_work"</h3>

    <div id="viz_for_table" class="special_div">
        <div>
            <p>Корреляция по пирсону</p>
            <img src="../static/corrtable.png">
        </div>
        <div>
            <p>Распределение по типам</p>
            <img src="../static/dots.png">
        </div>
    </div>
</div>

<script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
<script src="https://unpkg.com/gridjs/dist/gridjs.js"></script>
<script src="../static/script/mylang.js"></script>
<script type="module">
    import ru from "../static/script/mylang.js"
    import {
        Grid,
        h
    } from "../static/script/gridjs.js";

    var counter = 1; // global counter for messages
    const messages_levels = {0: 'Info:', 1: 'Warning:', 2: 'Critical:'}
    const tableDiv = document.getElementById('table');

    const updateUrl = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes = (data, row, col) => {
        if (row) {
            return {contentEditable: 'true', 'data-element-id': row.cells[0].data};
        } else {
            return {};
        }
    };

    const firstDataset = await getFullDatasetByName("mistakes_codes");

    for (const prop in firstDataset.columns) {
        firstDataset.columns[prop]['attributes'] = editableCellAttributes;
    }
    firstDataset.columns.push(
        {
            name: 'Действия',
            formatter: (cell, row) => {
                return h('button', {
                    className: 'btn btn-secondary',
                    onClick: () => alert(`Editing "${row.cells[0].data}" "${row.cells[1].data}"`)
                }, 'Удалить');
            }
        }
    );

    const mygrid = new gridjs.Grid({
        columns: firstDataset.columns,
        data: firstDataset.data,
        search: true,
        sort: {
            enabled: true,
            multiColumn: true,
        },
        pagination: true,
        language: ru
    }).render(tableDiv);

    let columnIds = Object.keys(mygrid.config.pagination);

    let savedValue;

    tableDiv.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue = ev.target.textContent;
        }
    });

    tableDiv.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD') {
            if (savedValue !== ev.target.textContent) {
                console.log(
                    JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    })
                );
                let tableName = document.querySelector('#database-name-option').value;
                writeMsg(`Таблица для изменения: ${tableName}`, 0);
                fetch('/api/data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        table_name: tableName,
                        data: {[ev.target.dataset.columnId]: ev.target.textContent}
                    }),
                });
            }
            savedValue = undefined;
        }
    });

    tableDiv.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });

    const db_select = document.querySelector('#database-name-option');
    db_select.addEventListener("change", updateGridJS);

    function writeMsg(msg, lvl) {
        let ms_field = document.querySelector('#sys-msgs');
        let node = document.createElement('li');
        node.appendChild(document.createTextNode(
            messages_levels[lvl] + `[${counter}]:` + " " + msg)
        );
        // добавляем сообщение
        ms_field.appendChild(node);
        counter += 1;
        // скроллим до самого низа
        document.querySelector('.system-messages').scrollTop = document.querySelector('.system-messages').scrollHeight;
    }

    async function getFullDatasetByName(name) {
        let host_url = 'http://localhost:5000'
        let api_url = '/api/fetch_dataset';
        let request_url = host_url + api_url + '?' + new URLSearchParams({db_name: name});
        console.log(request_url);
        let response = await fetch(request_url);
        writeMsg(`получил данные: ${name}`, 0)
        return await response.json()
    }

    async function updateGridJS(event) {
        let value = event.target.value;
        console.log(value);
        let jsonData = await getFullDatasetByName(value);
        let columns = jsonData.columns;
        let data = jsonData.data;
        console.log(columns, data);
        for (const prop in columns) {
            columns[prop]['attributes'] = editableCellAttributes;
        }
        await mygrid.updateConfig({
            columns: columns,
            data: data
        }).forceRender();
    }
</script>
</body>
{% endblock %}